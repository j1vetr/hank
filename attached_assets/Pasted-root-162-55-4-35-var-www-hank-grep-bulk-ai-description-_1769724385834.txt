root@162-55-4-35:/var/www/hank# grep "bulk-ai-description" /var/www/hank/dist/index.cjs
</html>`;o.setHeader("Content-Type","text/html; charset=utf-8"),o.send(y)}catch(d){console.error("Crawler middleware error:",d),u()}}),e.post("/api/admin/login",async(l,o)=>{try{let{username:u,password:p}=l.body,d=await x.getAdminUserByUsername(u);if(!d||!await ls.default.compare(p,d.password))return o.status(401).json({error:"Invalid credentials"});let f={adminUserId:d.id,email:d.username,type:"admin"},m=vp(f),h=await yp(f,l.headers["user-agent"],l.ip);xp(o,m,h,!0),o.json({success:!0,user:{id:d.id,username:d.username}})}catch(u){console.error("Admin login error:",u),o.status(500).json({error:"Login failed"})}}),e.post("/api/admin/logout",async(l,o)=>{try{let u=l.cookies?.refresh_token;u&&await gS(u),bp(o),o.json({success:!0})}catch{bp(o),o.json({success:!0})}}),e.get("/api/admin/me",async(l,o)=>{let u=await ft(l,o);if(!u||u.type!=="admin"||!u.adminUserId)return o.status(401).json({error:"Not authenticated"});let p=await x.getAdminUser(u.adminUserId);if(!p)return o.status(404).json({error:"User not found"});o.json({id:p.id,username:p.username})});let a=async(l,o,u)=>{let p=await ft(l,o);if(!p||p.type!=="admin"||!p.adminUserId)return o.status(401).json({error:"Unauthorized"});l.adminId=p.adminUserId,u()},c=["products","categories","hero","branding"];return e.post("/api/admin/upload/:type",a,fpe.array("images",10),async(l,o)=>{try{let u=l.params.type;if(!c.includes(u))return o.status(400).json({error:"Invalid upload type"});let p=l.files;if(!p||p.length===0)return o.status(400).json({error:"No files uploaded"});let d=await lj(p);console.log(`[Upload] Optimized ${d.length} images for ${u}`),o.json({urls:d})}catch(u){console.error("[Upload] Error:",u),o.status(500).json({error:"Upload failed"})}}),e.delete("/api/admin/upload",a,(l,o)=>{try{let{path:u}=l.body;if(!u||typeof u!="string")return o.status(400).json({error:"Invalid file path"});if(!u.startsWith("/uploads/"))return o.status(400).json({error:"Invalid file path"});if(u.includes("..")||u.includes("//"))return o.status(400).json({error:"Invalid file path"});let p=u.split("/").filter(Boolean);if(p.length<3||p[0]!=="uploads"||!c.includes(p[1]))return o.status(400).json({error:"Invalid file path"});let d=ct.default.join(process.cwd(),"client/public",u);Tt.default.existsSync(d)&&Tt.default.unlinkSync(d),o.json({success:!0})}catch{o.status(500).json({error:"Delete failed"})}}),e.get("/api/admin/stats",a,async(l,o)=>{try{let u=await x.getAdminStats();o.json(u)}catch{o.status(500).json({error:"Failed to fetch stats"})}}),e.get("/api/admin/users",a,async(l,o)=>{try{let{search:u}=l.query,p=await x.getUsers(u);o.json(p.map(d=>({...d,password:void 0})))}catch{o.status(500).json({error:"Failed to fetch users"})}}),e.get("/api/admin/users/:id",a,async(l,o)=>{try{let u=await x.getUser(l.params.id);if(!u)return o.status(404).json({error:"User not found"});o.json({...u,password:void 0})}catch{o.status(500).json({error:"Failed to fetch user"})}}),e.delete("/api/admin/users/:id",a,async(l,o)=>{try{await x.deleteUser(l.params.id),o.json({success:!0})}catch{o.status(500).json({error:"Failed to delete user"})}}),e.get("/api/admin/products",a,async(l,o)=>{try{let u=await x.getAllProducts();o.json(u)}catch{o.status(500).json({error:"Failed to fetch products"})}}),e.post("/api/auth/register",async(l,o)=>{try{let{email:u,password:p,firstName:d,lastName:f,phone:m,address:h,city:g,district:y,postalCode:b}=l.body;if(await x.getUserByEmail(u))return o.status(400).json({error:"Bu e-posta adresi zaten kay\u0131tl\u0131"});let T=await ls.default.hash(p,10),A=await x.createUser({email:u,password:T,firstName:d,lastName:f,phone:m,address:h,city:g,district:y,postalCode:b}),k={userId:A.id,email:A.email,type:"user"},I=vp(k),P=await yp(k,l.headers["user-agent"],l.ip);xp(o,I,P,!0),h&&g&&y&&d&&f&&m&&await x.createUserAddress({userId:A.id,title:"Ev Adresi",firstName:d,lastName:f,phone:m,address:h,city:g,district:y,postalCode:b||void 0,isDefault:!0}),ym(A).catch(F=>console.error("[Email] Welcome email failed:",F)),o.status(201).json({success:!0,user:{id:A.id,email:A.email,firstName:A.firstName,lastName:A.lastName}})}catch(u){console.error("Registration error:",u),o.status(500).json({error:"Kay\u0131t i\u015Flemi ba\u015Far\u0131s\u0131z"})}}),e.post("/api/auth/login",async(l,o)=>{try{let{email:u,password:p}=l.body,d=await x.getUserByEmail(u);if(!d||!await ls.default.compare(p,d.password))return o.status(401).json({error:"E-posta veya \u015Fifre hatal\u0131"});let f={userId:d.id,email:d.email,type:"user"},m=vp(f),h=await yp(f,l.headers["user-agent"],l.ip);xp(o,m,h,!0),o.json({success:!0,user:{id:d.id,email:d.email,firstName:d.firstName,lastName:d.lastName}})}catch(u){console.error("User login error:",u),o.status(500).json({error:"Giri\u015F i\u015Flemi ba\u015Far\u0131s\u0131z"})}}),e.post("/api/auth/logout",async(l,o)=>{try{let u=l.cookies?.refresh_token;u&&await gS(u),bp(o),o.json({success:!0})}catch{bp(o),o.json({success:!0})}}),e.get("/api/auth/me",async(l,o)=>{let u=await ft(l,o);if(!u||u.type!=="user"||!u.userId)return o.status(401).json({error:"Giri\u015F yap\u0131lmam\u0131\u015F"});let p=await x.getUser(u.userId);if(!p)return o.status(404).json({error:"Kullan\u0131c\u0131 bulunamad\u0131"});o.json({id:p.id,email:p.email,firstName:p.firstName,lastName:p.lastName,phone:p.phone,createdAt:p.createdAt})}),e.patch("/api/auth/profile",async(l,o)=>{let u=await ft(l,o);if(!u||u.type!=="user"||!u.userId)return o.status(401).json({error:"Giri\u015F yap\u0131lmam\u0131\u015F"});try{let{firstName:p,lastName:d,phone:f}=l.body,m=await x.updateUser(u.userId,{firstName:p,lastName:d,phone:f});if(!m)return o.status(404).json({error:"Kullan\u0131c\u0131 bulunamad\u0131"});o.json({id:m.id,email:m.email,firstName:m.firstName,lastName:m.lastName,phone:m.phone})}catch{o.status(500).json({error:"Profil g\xFCncellenemedi"})}}),e.get("/api/auth/addresses",async(l,o)=>{let u=await ft(l,o);if(!u||u.type!=="user"||!u.userId)return o.status(401).json({error:"Giri\u015F yap\u0131lmam\u0131\u015F"});try{let p=await x.getUserAddresses(u.userId);o.json(p)}catch{o.status(500).json({error:"Adresler y\xFCklenemedi"})}}),e.post("/api/auth/addresses",async(l,o)=>{let u=await ft(l,o);if(!u||u.type!=="user"||!u.userId)return o.status(401).json({error:"Giri\u015F yap\u0131lmam\u0131\u015F"});try{let{title:p,firstName:d,lastName:f,phone:m,address:h,city:g,district:y,postalCode:b,isDefault:S}=l.body,A=(await x.getUserAddresses(u.userId)).length===0?!0:!!S,k=await x.createUserAddress({userId:u.userId,title:p||"Adresim",firstName:d,lastName:f,phone:m,address:h,city:g,district:y,postalCode:b,isDefault:A});o.status(201).json(k)}catch{o.status(500).json({error:"Adres eklenemedi"})}}),e.patch("/api/auth/addresses/:id",async(l,o)=>{let u=await ft(l,o);if(!u||u.type!=="user"||!u.userId)return o.status(401).json({error:"Giri\u015F yap\u0131lmam\u0131\u015F"});try{let p=await x.getUserAddress(l.params.id);if(!p||p.userId!==u.userId)return o.status(404).json({error:"Adres bulunamad\u0131"});let{title:d,firstName:f,lastName:m,phone:h,address:g,city:y,district:b,postalCode:S,isDefault:T}=l.body,A=await x.updateUserAddress(l.params.id,{title:d,firstName:f,lastName:m,phone:h,address:g,city:y,district:b,postalCode:S,isDefault:T});o.json(A)}catch{o.status(500).json({error:"Adres g\xFCncellenemedi"})}}),e.delete("/api/auth/addresses/:id",async(l,o)=>{let u=await ft(l,o);if(!u||u.type!=="user"||!u.userId)return o.status(401).json({error:"Giri\u015F yap\u0131lmam\u0131\u015F"});try{let p=await x.getUserAddress(l.params.id);if(!p||p.userId!==u.userId)return o.status(404).json({error:"Adres bulunamad\u0131"});await x.deleteUserAddress(l.params.id),o.json({success:!0})}catch{o.status(500).json({error:"Adres silinemedi"})}}),e.patch("/api/auth/addresses/:id/default",async(l,o)=>{let u=await ft(l,o);if(!u||u.type!=="user"||!u.userId)return o.status(401).json({error:"Giri\u015F yap\u0131lmam\u0131\u015F"});try{let p=await x.getUserAddress(l.params.id);if(!p||p.userId!==u.userId)return o.status(404).json({error:"Adres bulunamad\u0131"});await x.setDefaultAddress(u.userId,l.params.id),o.json({success:!0})}catch{o.status(500).json({error:"Varsay\u0131lan adres ayarlanamad\u0131"})}}),e.get("/api/orders/my",async(l,o)=>{let u=await ft(l,o);if(!u||u.type!=="user"||!u.userId)return o.status(401).json({error:"Giri\u015F yap\u0131lmam\u0131\u015F"});try{let p=await x.getUser(u.userId);if(!p)return o.status(404).json({error:"Kullan\u0131c\u0131 bulunamad\u0131"});let d=await x.getOrdersByEmail(p.email);o.json(d)}catch{o.status(500).json({error:"Sipari\u015Fler y\xFCklenemedi"})}}),e.get("/api/orders/my/:id",async(l,o)=>{let u=await ft(l,o);if(!u||u.type!=="user"||!u.userId)return o.status(401).json({error:"Giri\u015F yap\u0131lmam\u0131\u015F"});try{let p=await x.getOrder(l.params.id);if(!p)return o.status(404).json({error:"Sipari\u015F bulunamad\u0131"});let d=await x.getUser(u.userId);if(!d||p.customerEmail!==d.email)return o.status(403).json({error:"Bu sipari\u015Fe eri\u015Fim yetkiniz yok"});let f=await x.getOrderItems(p.id);o.json({...p,items:f})}catch{o.status(500).json({error:"Sipari\u015F y\xFCklenemedi"})}}),e.get("/api/orders/track",async(l,o)=>{try{let{orderNumber:u,email:p}=l.query;if(!u||typeof u!="string")return o.status(400).json({error:"Sipari\u015F numaras\u0131 gerekli"});let d=await x.getOrderByNumber(u);if(!d)return o.status(404).json({error:"Sipari\u015F bulunamad\u0131"});if(p&&typeof p=="string"&&d.customerEmail.toLowerCase()!==p.toLowerCase())return o.status(404).json({error:"Sipari\u015F bulunamad\u0131"});let f=await x.getOrderItems(d.id);o.json({id:d.id,orderNumber:d.orderNumber,status:d.status,customerName:d.customerName,createdAt:d.createdAt,total:d.total,shippingCost:d.shippingCost,trackingNumber:d.trackingNumber,trackingUrl:d.trackingUrl,shippingCarrier:d.shippingCarrier,shippingAddress:d.shippingAddress,items:f.map(m=>({id:m.id,productName:m.productName,variantDetails:m.variantDetails,quantity:m.quantity,subtotal:m.subtotal}))})}catch(u){console.error("[Order Track] Error:",u),o.status(500).json({error:"Sipari\u015F bilgisi al\u0131namad\u0131"})}}),e.get("/api/categories",async(l,o)=>{try{let u=await x.getCategories();o.json(u)}catch{o.status(500).json({error:"Failed to fetch categories"})}}),e.get("/api/categories/:slug",async(l,o)=>{try{let u=await x.getCategoryBySlug(l.params.slug);if(!u)return o.status(404).json({error:"Category not found"});o.json(u)}catch{o.status(500).json({error:"Failed to fetch category"})}}),e.post("/api/admin/categories",a,async(l,o)=>{try{let u=qR.parse(l.body),p=await x.createCategory(u);o.status(201).json(p)}catch{o.status(400).json({error:"Invalid category data"})}}),e.patch("/api/admin/categories/:id",a,async(l,o)=>{try{let u=await x.updateCategory(l.params.id,l.body);if(!u)return o.status(404).json({error:"Category not found"});o.json(u)}catch{o.status(400).json({error:"Failed to update category"})}}),e.delete("/api/admin/categories/:id",a,async(l,o)=>{try{await x.deleteCategory(l.params.id),o.json({success:!0})}catch{o.status(500).json({error:"Failed to delete category"})}}),e.get("/api/products",async(l,o)=>{try{let{categoryId:u,isFeatured:p,isNew:d,search:f,minPrice:m,maxPrice:h,sort:g}=l.query,y=await x.getProducts({categoryId:u,isFeatured:p!==void 0?p==="true":void 0,isNew:d!==void 0?d==="true":void 0,search:f,minPrice:m?parseFloat(m):void 0,maxPrice:h?parseFloat(h):void 0,sort:g});o.json(y)}catch{o.status(500).json({error:"Failed to fetch products"})}}),e.get("/api/products/:slug",async(l,o)=>{try{let u=await x.getProductBySlug(l.params.slug);if(!u)return o.status(404).json({error:"Product not found"});let p=await x.getProductVariants(u.id);o.json({...u,variants:p})}catch{o.status(500).json({error:"Failed to fetch product"})}}),e.post("/api/admin/products",a,async(l,o)=>{try{let u=LR.parse(l.body),p=await x.createProduct(u),d=p.availableSizes||[],f=p.availableColors||[],m=p.sku||"";if(d.length>0)if(f.length>0)for(let h of d)for(let g of f){let y=m?`${m}-${h}`:null;await x.createProductVariant({productId:p.id,size:h,color:g.name,sku:y,stock:0,price:p.basePrice})}else for(let h of d){let g=m?`${m}-${h}`:null;await x.createProductVariant({productId:p.id,size:h,color:null,sku:g,stock:0,price:p.basePrice})}o.status(201).json(p)}catch(u){console.error("Product creation error:",u),o.status(400).json({error:"Invalid product data"})}}),e.patch("/api/admin/products/:id",a,async(l,o)=>{try{console.log("Updating product:",l.params.id,"with data:",JSON.stringify(l.body,null,2));let u=await x.updateProduct(l.params.id,l.body);if(!u)return o.status(404).json({error:"Product not found"});let p=u.availableSizes||[],d=u.availableColors||[],f=u.sku||"",m=await x.getProductVariants(u.id);if(p.length>0){if(d.length>0){for(let h of p)for(let g of d)if(!m.some(b=>b.size===h&&b.color===g.name)){let b=f?`${f}-${h}`:null;await x.createProductVariant({productId:u.id,size:h,color:g.name,sku:b,stock:0,price:u.basePrice}),console.log(`Created missing variant: ${h} / ${g.name} for product ${u.id}`)}}else for(let h of p)if(!m.some(y=>y.size===h&&!y.color)){let y=f?`${f}-${h}`:null;await x.createProductVariant({productId:u.id,size:h,color:null,sku:y,stock:0,price:u.basePrice}),console.log(`Created missing variant: ${h} for product ${u.id}`)}}console.log("Updated product result:",JSON.stringify(u,null,2)),o.json(u)}catch(u){console.error("Product update error:",u),o.status(400).json({error:"Failed to update product"})}}),e.delete("/api/admin/products/:id",a,async(l,o)=>{try{await x.deleteProduct(l.params.id),o.json({success:!0})}catch{o.status(500).json({error:"Failed to delete product"})}}),e.post("/api/admin/products/:id/generate-description",a,async(l,o)=>{try{let{style:u}=l.body;if(!u||!["professional","energetic","minimal","luxury","sporty"].includes(u))return o.status(400).json({error:"Ge\xE7erli bir stil se\xE7in"});let p=await x.getProduct(l.params.id);if(!p)return o.status(404).json({error:"\xDCr\xFCn bulunamad\u0131"});let d=null;if(p.images&&p.images.length>0){let m=p.images[0];if(m.startsWith("http"))d=m;else{let h=l.protocol,g=l.get("host");d=`${h}://${g}${m}`}}let f=await k_(p.name,d,u);o.json({description:f,style:Ym[u]})}catch(u){console.error("AI description generation error:",u),o.status(500).json({error:"A\xE7\u0131klama olu\u015Fturulurken bir hata olu\u015Ftu"})}}),e.get("/api/admin/ai-styles",a,async(l,o)=>{o.json({styles:[{id:"professional",name:"Profesyonel",description:"Kurumsal ve g\xFCvenilir ton"},{id:"energetic",name:"Enerjik",description:"Dinamik ve motive edici"},{id:"minimal",name:"Minimal",description:"K\u0131sa ve \xF6z"},{id:"luxury",name:"L\xFCks",description:"Premium ve sofistike"},{id:"sporty",name:"Sportif",description:"Atletik ve performans odakl\u0131"}]})}),e.post("/api/admin/products/bulk-ai-description",a,async(l,o)=>{try{let p=it.object({style:it.enum(["professional","energetic","minimal","luxury","sporty"]),categoryId:it.string().optional(),onlyEmpty:it.boolean().optional().default(!1),overwrite:it.boolean().optional().default(!1)}).safeParse(l.body);if(!p.success)return o.status(400).json({error:"Ge\xE7ersiz istek parametreleri"});let{style:d,categoryId:f,onlyEmpty:m,overwrite:h}=p.data,g=await x.getProducts();if(f&&(g=g.filter(T=>T.categoryId===f)),m&&(g=g.filter(T=>!T.description||T.description.trim()==="")),g.length===0)return o.json({message:"Filtrelere uyan \xFCr\xFCn bulunamad\u0131.",total:0,successful:0,failed:0,results:[]});let y=[];for(let T of g)try{if(T.description&&T.description.trim()!==""&&!h){y.push({productId:T.id,productName:T.name,success:!0});continue}let A=null;if(T.images&&T.images.length>0){let I=T.images[0];if(I.startsWith("http"))A=I;else{let P=l.protocol,$=l.get("host");A=`${P}://${$}${I}`}}let k=await k_(T.name,A,d);await x.updateProduct(T.id,{description:k}),y.push({productId:T.id,productName:T.name,success:!0}),await new Promise(I=>setTimeout(I,500))}catch(A){console.error(`AI description error for product ${T.id}:`,A),y.push({productId:T.id,productName:T.name,success:!1,error:A instanceof Error?A.message:"Bilinmeyen hata"})}let b=y.filter(T=>T.success).length,S=y.filter(T=>!T.success).length;o.json({message:`${b} \xFCr\xFCn ba\u015Far\u0131yla g\xFCncellendi, ${S} \xFCr\xFCn hatal\u0131.`,total:g.length,successful:b,failed:S,results:y})}catch(u){console.error("Bulk AI description error:",u),o.status(500).json({error:"Toplu a\xE7\u0131klama olu\u015Fturulurken bir hata olu\u015Ftu"})}}),e.post("/api/admin/products/bulk-price",a,async(l,o)=>{try{let{categoryId:u,action:p,value:d}=l.body;if(!u||!p||d===void 0)return o.status(400).json({error:"categoryId, action and value are required"});let m=(await x.getProducts()).filter(g=>g.categoryId===u);if(m.length===0)return o.status(400).json({error:"Bu kategoride \xFCr\xFCn bulunamad\u0131"});let h=0;for(let g of m){let y,b=parseFloat(g.basePrice);switch(p){case"set":y=d;break;case"increase":y=b+d;break;case"decrease":y=Math.max(0,b-d);break;case"percent_increase":y=b*(1+d/100);break;case"percent_decrease":y=b*(1-d/100);break;default:continue}y=Math.round(y*100)/100,await x.updateProduct(g.id,{basePrice:String(y)}),h++}o.json({success:!0,updated:h})}catch(u){console.error("Bulk price update error:",u),o.status(500).json({error:"Toplu fiyat g\xFCncellemesi ba\u015Far\u0131s\u0131z"})}}),e.delete("/api/admin/products-all",a,async(l,o)=>{try{let u=await x.deleteAllProducts();for(let p of u.imagePaths)try{let d=ct.default.join(process.cwd(),"client/public",p);Tt.default.existsSync(d)&&Tt.default.unlinkSync(d)}catch(d){console.error(`Failed to delete image: ${p}`,d)}o.json({success:!0,deletedProducts:u.deletedProducts,deletedVariants:u.deletedVariants,deletedImages:u.imagePaths.length})}catch(u){console.error("Delete all products error:",u),o.status(500).json({error:u.message||"Failed to delete products"})}}),e.get("/api/products/:productId/variants",async(l,o)=>{try{let u=await x.getProductVariants(l.params.productId);o.json(u)}catch{o.status(500).json({error:"Failed to fetch variants"})}}),e.post("/api/admin/products/:productId/variants",a,async(l,o)=>{try{let u=DR.parse({...l.body,productId:l.params.productId}),p=await x.createProductVariant(u);o.status(201).json(p)}catch{o.status(400).json({error:"Invalid variant data"})}}),e.patch("/api/admin/variants/:id",a,async(l,o)=>{try{let u=await x.updateProductVariant(l.params.id,l.body);if(!u)return o.status(404).json({error:"Variant not found"});o.json(u)}catch{o.status(400).json({error:"Failed to update variant"})}}),e.delete("/api/admin/variants/:id",a,async(l,o)=>{try{await x.deleteProductVariant(l.params.id),o.json({success:!0})}catch{o.status(500).json({error:"Failed to delete variant"})}}),e.get("/api/cart",async(l,o)=>{try{let u=Bc(l,o),p=await x.getCartItems(u);o.json(p)}catch{o.status(500).json({error:"Failed to fetch cart"})}}),e.post("/api/cart",async(l,o)=>{try{let u=Bc(l,o),{productId:p,variantId:d,quantity:f}=l.body,m=await x.getProduct(p);if(!m)return o.status(400).json({error:"Ge\xE7ersiz \xFCr\xFCn"});if(m.availableSizes&&m.availableSizes.length>0&&!d)return o.status(400).json({error:"L\xFCtfen beden se\xE7imi yap\u0131n"});if(d){let y=await x.getProductVariant(d);if(!y)return o.status(400).json({error:"Ge\xE7ersiz varyant se\xE7imi"});if(y.productId!==p)return o.status(400).json({error:"Ge\xE7ersiz varyant"});if(y.stock<=0)return o.status(400).json({error:"Bu beden stokta yok"})}let h=$R.parse({productId:p,variantId:d,quantity:f||1,sessionId:u}),g=await x.addToCart(h);o.status(201).json(g)}catch(u){console.error("Add to cart error:",u),o.status(400).json({error:"Sepete eklenemedi"})}}),e.patch("/api/cart/:id",async(l,o)=>{try{let{quantity:u}=l.body,p=await x.updateCartItem(l.params.id,u);if(!p)return o.status(404).json({error:"Cart item not found"});o.json(p)}catch{o.status(400).json({error:"Failed to update cart item"})}}),e.delete("/api/cart/:id",async(l,o)=>{try{await x.removeFromCart(l.params.id),o.json({success:!0})}catch{o.status(500).json({error:"Failed to remove from cart"})}}),e.delete("/api/cart",async(l,o)=>{try{let u=Bc(l,o);await x.clearCart(u),o.json({success:!0})}catch{o.status(500).json({error:"Failed to clear cart"})}}),e.get("/api/favorites",async(l,o)=>{try{let u=await ft(l,o),p=u?.type==="user"?u.userId:null;if(!p)return o.status(401).json({error:"Please login to view favorites"});let d=await x.getFavoriteProducts(p);o.json(d)}catch{o.status(500).json({error:"Failed to fetch favorites"})}}),e.get("/api/favorites/ids",async(l,o)=>{try{let u=await ft(l,o),p=u?.type==="user"?u.userId:null;if(!p)return o.json([]);let d=await x.getUserFavoriteProductIds(p);o.json(d)}catch{o.status(500).json({error:"Failed to fetch favorite ids"})}}),e.get("/api/favorites/:productId/check",async(l,o)=>{try{let u=await ft(l,o),p=u?.type==="user"?u.userId:null;if(!p)return o.json({isFavorite:!1});let d=await x.isFavorite(p,l.params.productId);o.json({isFavorite:d})}catch{o.status(500).json({error:"Failed to check favorite status"})}}),e.post("/api/favorites/:productId",async(l,o)=>{try{let u=await ft(l,o),p=u?.type==="user"?u.userId:null;if(!p)return o.status(401).json({error:"Please login to add favorites"});let d=await x.addFavorite({userId:p,productId:l.params.productId});o.status(201).json(d)}catch{o.status(500).json({error:"Failed to add favorite"})}}),e.delete("/api/favorites/:productId",async(l,o)=>{try{let u=await ft(l,o),p=u?.type==="user"?u.userId:null;if(!p)return o.status(401).json({error:"Please login to remove favorites"});await x.removeFavorite(p,l.params.productId),o.json({success:!0})}catch{o.status(500).json({error:"Failed to remove favorite"})}}),e.get("/api/products/:productId/reviews",async(l,o)=>{try{let u=await x.getProductReviews(l.params.productId);o.json(u)}catch{o.status(500).json({error:"Failed to fetch reviews"})}}),e.get("/api/products/:productId/rating",async(l,o)=>{try{let u=await x.getProductAverageRating(l.params.productId);o.json(u)}catch{o.status(500).json({error:"Failed to fetch rating"})}}),e.post("/api/products/:productId/reviews",async(l,o)=>{try{let u=await ft(l,o),p=u?.type==="user"?u.userId:null;if(!p)return o.status(401).json({error:"Please login to write a review"});if(await x.getUserReview(p,l.params.productId))return o.status(400).json({error:"You have already reviewed this product"});let{rating:f,title:m,content:h}=l.body;if(!f||f<1||f>5)return o.status(400).json({error:"Rating must be between 1 and 5"});let g=await x.createReview({productId:l.params.productId,userId:p,rating:f,title:m||null,content:h||null});o.status(201).json(g)}catch{o.status(500).json({error:"Failed to create review"})}}),e.get("/api/products/:productId/my-review",async(l,o)=>{try{let u=await ft(l,o),p=u?.type==="user"?u.userId:null;if(!p)return o.json(null);let d=await x.getUserReview(p,l.params.productId);o.json(d||null)}catch{o.status(500).json({error:"Failed to fetch review"})}}),e.post("/api/payment/create",async(l,o)=>{try{let u=Bc(l,o),p=await ft(l,o),d=p?.type==="user"?p.userId??null:null,f=await x.getCartItems(u);if(f.length===0)return o.status(400).json({error:"Sepet bo\u015F"});let{customerName:m,customerEmail:h,customerPhone:g,address:y,city:b,district:S,postalCode:T,country:A,couponCode:k,createAccount:I,accountPassword:P}=l.body,$=A||"T\xFCrkiye";if(!m||!h||!g||!y||!b||!S)return o.status(400).json({error:"L\xFCtfen t\xFCm alanlar\u0131 doldurun"});let F=null;if(I&&P){if(P.length<6)return o.status(400).json({error:"\u015Eifre en az 6 karakter olmal\u0131"});if(await x.getUserByEmail(h))return o.status(400).json({error:"Bu e-posta adresi zaten kay\u0131tl\u0131. Giri\u015F yaparak devam edebilirsiniz."});F=await ls.default.hash(P,10)}let ie=0,B=[],X=[];for(let Wr of f){let zc=Wr.variantId?await x.getProductVariant(Wr.variantId):null,UD=zc?.productId||Wr.productId,Ca=await x.getProduct(UD);if(Ca){let ES=parseFloat(Ca.basePrice);ie+=ES*Wr.quantity,B.push({productId:Ca.id,variantId:zc?.id||null,quantity:Wr.quantity,productName:Ca.name,variantDetails:zc?`${zc.size||""} ${zc.color||""}`.trim():null,price:Ca.basePrice}),X.push([Ca.name.substring(0,50),Math.round(ES*100).toString(),Wr.quantity])}}let ee=null,H=0;if(k){let Wr=await x.validateCoupon(k,ie,d||void 0);Wr.valid&&Wr.coupon&&(ee=Wr.coupon,ee.discountType==="percentage"?H=ie*parseFloat(ee.discountValue)/100:H=parseFloat(ee.discountValue),H=Math.min(H,ie))}let Ae=$==="T\xFCrkiye"?ie>=2500?0:200:2500,Kt=Math.max(0,ie-H+Ae),cr=`HNK${Date.now()}${Math.random().toString(36).substr(2,5).toUpperCase()}`,zD=l.headers["x-forwarded-for"]?.toString().split(",")[0].trim()||l.socket.remoteAddress||"127.0.0.1",SS="https://hank.com.tr",Nh=new Date;Nh.setHours(Nh.getHours()+1),await x.createPendingPayment({merchantOid:cr,sessionId:u,customerName:m,customerEmail:h,customerPhone:g,shippingAddress:{address:y,city:b,district:S,postalCode:T||"",country:$},cartItems:B,subtotal:ie.toFixed(2),shippingCost:Ae.toFixed(2),discountAmount:H.toFixed(2),couponCode:ee?.code||null,total:Kt.toFixed(2),status:"pending",paytrToken:null,createAccount:I||!1,accountPasswordHash:F,expiresAt:Nh});let Ta=await eq({merchantOid:cr,userIp:zD,email:h,paymentAmount:Math.round(Kt*100),userName:m,userAddress:`${y}, ${S}, ${b}`,userPhone:g,userBasket:X,okUrl:`${SS}/odeme-basarili?oid=${cr}`,failUrl:`${SS}/odeme-basarisiz?oid=${cr}`,noInstallment:"1",currency:"TL",testMode:"0",debugOn:"1"});Ta.status==="success"&&Ta.token?(await x.updatePendingPaymentStatus(cr,"token_received"),o.json({success:!0,token:Ta.token,merchantOid:cr,iframeUrl:`https://www.paytr.com/odeme/guvenli/${Ta.token}`})):(await x.deletePendingPayment(cr),console.error("[PayTR] Token request failed:",Ta.reason),o.status(400).json({error:"\xD6deme sistemi ba\u011Flant\u0131s\u0131 kurulamad\u0131. L\xFCtfen daha sonra tekrar deneyin.",reason:Ta.reason}))}catch(u){console.error("[PayTR] Payment creation error:",u),o.status(500).json({error:"\xD6deme i\u015Flemi ba\u015Flat\u0131lamad\u0131"})}}),e.post("/api/payment/callback",async(l,o)=>{try{let u=l.body;if(console.log("[PayTR Callback] Received:",{merchant_oid:u.merchant_oid,status:u.status,total_amount:u.total_amount}),!tq(u))return console.error("[PayTR Callback] Hash verification failed"),o.send("PAYTR notification failed: bad hash");let p=await x.getPendingPaymentByMerchantOid(u.merchant_oid);if(!p)return console.error("[PayTR Callback] Pending payment not found:",u.merchant_oid),o.send("OK");if(p.status==="completed"||p.status==="failed")return console.log("[PayTR Callback] Payment already processed:",u.merchant_oid),o.send("OK");if(u.status==="success"){let d=u.merchant_oid,f=await x.createOrder({orderNumber:d,customerName:p.customerName,customerEmail:p.customerEmail,customerPhone:p.customerPhone,shippingAddress:p.shippingAddress,subtotal:p.subtotal,shippingCost:p.shippingCost,discountAmount:p.discountAmount||"0",couponCode:p.couponCode,total:p.total,status:"confirmed",paymentMethod:"credit_card",paymentStatus:"paid"});for(let g of p.cartItems)if(await x.createOrderItem({orderId:f.id,productId:g.productId,variantId:g.variantId,productName:g.productName,variantDetails:g.variantDetails,price:g.price,quantity:g.quantity,subtotal:(parseFloat(g.price)*g.quantity).toFixed(2)}),g.variantId){let y=await x.getProductVariant(g.variantId);if(y){let b=Math.max(0,y.stock-g.quantity);await x.updateProductVariant(g.variantId,{stock:b}),await x.createStockAdjustment({variantId:g.variantId,previousStock:y.stock,newStock:b,adjustmentType:"sale",reason:`Sipari\u015F: ${d}`})}}if(p.couponCode){let g=await x.getCouponByCode(p.couponCode);if(g&&(await x.redeemCoupon(g.id,f.id,null,parseFloat(p.discountAmount||"0")),g.isInfluencerCode)){let y=0,b=parseFloat(p.total);switch(g.commissionType){case"percentage":y=b*parseFloat(g.commissionValue||"0")/100;break;case"per_use":y=parseFloat(g.commissionValue||"0");break}if(y>0){let S=parseFloat(g.totalCommissionEarned||"0");await x.updateCoupon(g.id,{totalCommissionEarned:(S+y).toFixed(2)})}}}await x.clearCart(p.sessionId),await x.updatePendingPaymentStatus(u.merchant_oid,"completed");let m=await x.getOrderItems(f.id);xm(f,m).catch(g=>console.error("[Email] Order confirmation failed:",g)),wm(f,m).catch(g=>console.error("[Email] Admin notification failed:",g));let h=new Map;for(let g of m)if(g.variantId){let y=await x.getProductVariant(g.variantId);y?.sku&&h.set(g.variantId,y.sku)}if(M1(f,m,h).catch(g=>console.error("[BizimHesap] Invoice failed:",g)),p.createAccount&&p.accountPasswordHash)try{if(!await x.getUserByEmail(p.customerEmail)){let y=p.customerName.trim().split(" "),b=y[0]||"",S=y.slice(1).join(" ")||"",T=p.shippingAddress,A=await x.createUser({email:p.customerEmail,password:p.accountPasswordHash,firstName:b,lastName:S,phone:p.customerPhone,address:T.address,city:T.city,district:T.district,postalCode:T.postalCode||null});await x.createUserAddress({userId:A.id,title:"Teslimat Adresi",firstName:b,lastName:S,phone:p.customerPhone,address:T.address,city:T.city,district:T.district,postalCode:T.postalCode||null,isDefault:!0}),ym(A).catch(k=>console.error("[Email] Welcome email failed:",k)),console.log("[PayTR Callback] User account created:",A.email)}}catch(g){console.error("[PayTR Callback] Failed to create user account:",g)}console.log("[PayTR Callback] Order created successfully:",d)}else await x.updatePendingPaymentStatus(u.merchant_oid,"failed"),console.log("[PayTR Callback] Payment failed:",u.merchant_oid,u.failed_reason_msg);o.send("OK")}catch(u){console.error("[PayTR Callback] Error:",u),o.send("OK")}}),e.get("/api/payment/status/:merchantOid",async(l,o)=>{try{let u=await x.getPendingPaymentByMerchantOid(l.params.merchantOid);if(!u)return o.status(404).json({error:"\xD6deme bulunamad\u0131"});if(u.status==="completed"){let p=await x.getOrderByNumber(u.merchantOid);return o.json({status:"completed",orderNumber:p?.orderNumber,orderId:p?.id})}o.json({status:u.status})}catch{o.status(500).json({error:"\xD6deme durumu al\u0131namad\u0131"})}}),e.get("/api/admin/orders",a,async(l,o)=>{try{let u=await x.getOrders();o.json(u)}catch{o.status(500).json({error:"Failed to fetch orders"})}}),e.get("/api/admin/orders/:id",a,async(l,o)=>{try{let u=await x.getOrder(l.params.id);if(!u)return o.status(404).json({error:"Order not found"});let p=await x.getOrderItems(u.id),d=await Promise.all(p.map(async f=>{let m=null,h=null;if(f.variantId){let g=await x.getProductVariant(f.variantId);if(m=g?.sku||null,g?.productId){let y=await x.getProduct(g.productId);h=y?.images?.[0]||null,m||(m=y?.sku||null)}}if(!h&&f.productId){let g=await x.getProduct(f.productId);h=g?.images?.[0]||null,m||(m=g?.sku||null)}return{...f,sku:m,productImage:h}}));o.json({...u,items:d})}catch{o.status(500).json({error:"Failed to fetch order"})}}),e.post("/api/orders",async(l,o)=>{try{let u=Bc(l,o),p=await ft(l,o),d=p?.type==="user"?p.userId??null:null,f=await x.getCartItems(u);if(f.length===0)return o.status(400).json({error:"Cart is empty"});let m=`HNK${Date.now()}`,h=0;for(let B of f){let ee=(B.variantId?await x.getProductVariant(B.variantId):null)?.productId||B.productId,H=await x.getProduct(ee);if(H){let oe=parseFloat(H.basePrice);h+=oe*B.quantity}}let g=null,y=0;if(l.body.couponCode){let B=await x.validateCoupon(l.body.couponCode,h,d||void 0);B.valid&&B.coupon&&(g=B.coupon,g.discountType==="percentage"?y=h*parseFloat(g.discountValue)/100:y=parseFloat(g.discountValue),y=Math.min(y,h))}let I=(l.body.shippingAddress?.country||"T\xFCrkiye")==="T\xFCrkiye"?h>=2500?0:200:2500,P=Math.max(0,h-y+I),$=FR.parse({...l.body,orderNumber:m,subtotal:h.toFixed(2),shippingCost:I.toFixed(2),couponCode:g?.code||null,discountAmount:y.toFixed(2),total:P.toFixed(2)}),F=await x.createOrder($);if(g&&(await x.redeemCoupon(g.id,F.id,d,y),g.isInfluencerCode)){let B=0;switch(g.commissionType){case"percentage":B=P*parseFloat(g.commissionValue||"0")/100;break;case"per_use":B=parseFloat(g.commissionValue||"0");break;case"fixed_total":break}if(B>0){let X=parseFloat(g.totalCommissionEarned||"0");await x.updateCoupon(g.id,{totalCommissionEarned:(X+B).toFixed(2)})}}for(let B of f){let X=B.variantId?await x.getProductVariant(B.variantId):null,ee=X?.productId||B.productId,H=await x.getProduct(ee);if(H&&(await x.createOrderItem({orderId:F.id,productId:H.id,variantId:X?.id,productName:H.name,variantDetails:X?`${X.size||""} ${X.color||""}`.trim():null,price:H.basePrice,quantity:B.quantity,subtotal:(parseFloat(H.basePrice)*B.quantity).toFixed(2)}),X&&X.id)){let oe=Math.max(0,X.stock-B.quantity);await x.updateProductVariant(X.id,{stock:oe}),await x.createStockAdjustment({variantId:X.id,previousStock:X.stock,newStock:oe,adjustmentType:"sale",reason:`Sipari\u015F: ${m}`})}}await x.clearCart(u);let ie=await x.getOrderItems(F.id);xm(F,ie).catch(B=>console.error("[Email] Order confirmation failed:",B)),wm(F,ie).catch(B=>console.error("[Email] Admin notification failed:",B)),o.status(201).json(F)}catch(u){console.error("Order creation error:",u),o.status(400).json({error:"Failed to create order"})}}),e.patch("/api/admin/orders/:id/status",a,async(l,o)=>{try{let{status:u,trackingNumber:p}=l.body,d={status:u};if(u==="shipped"&&p){let m=`https://www.dhl.com/tr-tr/home/tracking.html?tracking-id=${p}&submit=1`;d={...d,trackingNumber:p,shippingCarrier:"DHL Express",trackingUrl:m}}let f=await x.updateOrder(l.params.id,d);if(!f)return o.status(404).json({error:"Order not found"});u==="processing"?j1(f).catch(m=>console.error("[Email] Preparing notification failed:",m)):u==="shipped"&&bm(f).catch(m=>console.error("[Email] Shipping notification failed:",m)),o.json(f)}catch(u){console.error("Order status update error:",u),o.status(400).json({error:"Failed to update order status"})}}),e.post("/api/admin/init",async(l,o)=>{try{let{username:u,password:p}=l.body;if(await x.getAdminUserByUsername(u))return o.status(400).json({error:"Admin user already exists"});let f=await ls.default.hash(p,10),m=await x.createAdminUser({username:u,password:f});o.status(201).json({id:m.id,username:m.username})}catch{o.status(500).json({error:"Failed to create admin user"})}}),e.get("/api/admin/woocommerce/settings",a,async(l,o)=>{try{let u=await x.getWoocommerceSettings();u?o.json({...u,consumerSecret:u.consumerSecret?"\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022":""}):o.json(null)}catch{o.status(500).json({error:"Failed to fetch WooCommerce settings"})}}),e.post("/api/admin/woocommerce/settings",a,async(l,o)=>{try{let{siteUrl:u,consumerKey:p,consumerSecret:d,isActive:f}=l.body,m=await x.saveWoocommerceSettings({siteUrl:u,consumerKey:p,consumerSecret:d,isActive:f??!0});o.json({...m,consumerSecret:"\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022"})}catch{o.status(500).json({error:"Failed to save WooCommerce settings"})}}),e.delete("/api/admin/woocommerce/settings",a,async(l,o)=>{try{await x.deleteWoocommerceSettings(),o.json({success:!0})}catch{o.status(500).json({error:"Failed to delete WooCommerce settings"})}}),e.post("/api/admin/woocommerce/test",a,async(l,o)=>{try{let{siteUrl:u,consumerKey:p,consumerSecret:d}=l.body,f=new URL("/wp-json/wc/v3/products",u);f.searchParams.set("per_page","1");let m=Buffer.from(`${p}:${d}`).toString("base64"),h=await fetch(f.toString(),{headers:{Authorization:`Basic ${m}`}});if(!h.ok){let S=await h.text();return o.status(400).json({success:!1,error:`WooCommerce API hatas\u0131: ${h.status}`,details:S})}let g=await h.json(),y=h.headers.get("X-WP-Total")||"0",b=await fetch(new URL("/wp-json/wc/v3/products/categories?per_page=1",u).toString(),{headers:{Authorization:`Basic ${m}`}}).then(S=>S.headers.get("X-WP-Total")||"0").catch(()=>"0");o.json({success:!0,productCount:parseInt(y),categoryCount:parseInt(b),message:"Ba\u011Flant\u0131 ba\u015Far\u0131l\u0131!"})}catch(u){o.status(500).json({success:!1,error:u.message||"Ba\u011Flant\u0131 hatas\u0131"})}}),e.get("/api/admin/woocommerce/logs",a,async(l,o)=>{try{let u=await x.getWoocommerceSyncLogs();o.json(u)}catch{o.status(500).json({error:"Failed to fetch sync logs"})}}),e.post("/api/admin/woocommerce/import",a,async(l,o)=>{try{let u=await x.getWoocommerceSettings();if(!u)return o.status(400).json({error:"WooCommerce ayarlar\u0131 bulunamad\u0131"});let p=await x.createWoocommerceSyncLog("running");(async()=>{let d=0,f=0,m=0,h=[];try{let g=Buffer.from(`${u.consumerKey}:${u.consumerSecret}`).toString("base64"),y=new URL("/wp-json/wc/v3/products/categories",u.siteUrl);y.searchParams.set("per_page","100");let b=await fetch(y.toString(),{headers:{Authorization:`Basic ${g}`}});if(b.ok){let A=await b.json();for(let k of A)try{if(!await x.getCategoryBySlugOrCreate(k.slug)){let P="";if(k.image?.src)try{let $=await fetch(k.image.src);if($.ok){let F=await $.arrayBuffer(),ie=`${k.slug}-${Date.now()}`,B=ct.default.join(process.cwd(),"client/public/uploads/categories",`${ie}.tmp`);P=(await Bw(Buffer.from(F),B)).replace(process.cwd()+"/client/public",""),m++}}catch{h.push(`Kategori resmi indirilemedi: ${k.name}`)}await x.createCategory({name:k.name,slug:k.slug,image:P,displayOrder:k.menu_order||0}),f++}}catch(I){h.push(`Kategori aktar\u0131lamad\u0131: ${k.name} - ${I.message}`)}}let S=1,T=!0;for(;T;){let A=new URL("/wp-json/wc/v3/products",u.siteUrl);A.searchParams.set("per_page","20"),A.searchParams.set("page",S.toString()),A.searchParams.set("status","publish");let k=await fetch(A.toString(),{headers:{Authorization:`Basic ${g}`}});if(!k.ok){h.push(`\xDCr\xFCnler al\u0131namad\u0131 (sayfa ${S})`);break}let I=await k.json();if(I.length===0){T=!1;break}for(let P of I)try{if(!await x.getProductBySlug(P.slug)){let F=[];for(let H of P.images||[])try{let oe=await fetch(H.src);if(oe.ok){let me=await oe.arrayBuffer(),$e=`${P.slug}-${Date.now()}-${F.length+1}`,or=ct.default.join(process.cwd(),"client/public/uploads/products",`${$e}.tmp`),Kt=(await Bw(Buffer.from(me),or)).replace(process.cwd()+"/client/public","");F.push(Kt),m++}}catch{h.push(`\xDCr\xFCn resmi indirilemedi: ${P.name}`)}let ie=null;P.categories&&P.categories.length>0&&(ie=(await x.getCategoryBySlugOrCreate(P.categories[0].slug))?.id||null);let B=[],X=[];for(let H of P.attributes||[])if((H.name.toLowerCase().includes("beden")||H.name.toLowerCase().includes("size"))&&B.push(...H.options||[]),H.name.toLowerCase().includes("renk")||H.name.toLowerCase().includes("color"))for(let oe of H.options||[])X.push({name:oe,hex:"#000000"});let ee=await x.createProduct({name:P.name,slug:P.slug,description:P.description?.replace(/<[^>]*>/g,"")||"",sku:P.sku||null,categoryId:ie,basePrice:P.price||P.regular_price||"0",images:F,availableSizes:B,availableColors:X,isActive:P.status==="publish",isFeatured:P.featured||!1,isNew:!1});if(d++,P.type==="variable"&&ee)try{let H=new URL(`/wp-json/wc/v3/products/${P.id}/variations`,u.siteUrl);H.searchParams.set("per_page","100");let oe=await fetch(H.toString(),{headers:{Authorization:`Basic ${g}`}});if(oe.ok){let me=await oe.json();for(let $e of me){let or="",Ae="",Kt="#000000";for(let cr of $e.attributes||[])(cr.name.toLowerCase().includes("beden")||cr.name.toLowerCase().includes("size"))&&(or=cr.option||""),(cr.name.toLowerCase().includes("renk")||cr.name.toLowerCase().includes("color"))&&(Ae=cr.option||"");await x.createProductVariant({productId:ee.id,sku:$e.sku||null,size:or||null,color:Ae||null,colorHex:Kt,price:$e.price||P.price||"0",stock:$e.stock_quantity||0,isActive:$e.status==="publish"})}}}catch{h.push(`Varyasyonlar al\u0131namad\u0131: ${P.name}`)}else if(ee)if(B.length>0&&X.length>0)for(let H of B)for(let oe of X)await x.createProductVariant({productId:ee.id,sku:P.sku?`${P.sku}-${H}-${oe.name}`:null,size:H,color:oe.name,colorHex:oe.hex,price:P.price||"0",stock:P.stock_quantity||0,isActive:!0});else if(B.length>0)for(let H of B)await x.createProductVariant({productId:ee.id,sku:P.sku?`${P.sku}-${H}`:null,size:H,color:null,colorHex:null,price:P.price||"0",stock:P.stock_quantity||0,isActive:!0});else if(X.length>0)for(let H of X)await x.createProductVariant({productId:ee.id,sku:P.sku?`${P.sku}-${H.name}`:null,size:null,color:H.name,colorHex:H.hex,price:P.price||"0",stock:P.stock_quantity||0,isActive:!0});else await x.createProductVariant({productId:ee.id,sku:P.sku||null,size:null,color:null,colorHex:null,price:P.price||"0",stock:P.stock_quantity||0,isActive:!0})}}catch($){h.push(`\xDCr\xFCn aktar\u0131lamad\u0131: ${P.name} - ${$.message}`)}if(S++,S>50)break}await x.updateWoocommerceLastSync(),await x.updateWoocommerceSyncLog(p.id,{status:"completed",productsImported:d,categoriesImported:f,imagesDownloaded:m,errors:h,completedAt:new Date})}catch(g){await x.updateWoocommerceSyncLog(p.id,{status:"failed",productsImported:d,categoriesImported:f,imagesDownloaded:m,errors:[...h,g.message],completedAt:new Date})}})(),o.json({success:!0,logId:p.id,message:"\u0130\xE7e aktarma ba\u015Flat\u0131ld\u0131"})}catch(u){o.status(500).json({error:u.message||"\u0130\xE7e aktarma ba\u015Flat\u0131lamad\u0131"})}}),e.get("/api/admin/analytics/sales",a,async(l,o)=>{try{let u=l.query.period||"month",p=await x.getSalesAnalytics(u);o.json(p)}catch{o.status(500).json({error:"Failed to fetch sales analytics"})}}),e.get("/api/admin/analytics/best-sellers",a,async(l,o)=>{try{let u=parseInt(l.query.limit)||10,p=await x.getBestSellingProducts(u);o.json(p)}catch{o.status(500).json({error:"Failed to fetch best sellers"})}}),e.get("/api/admin/analytics/comparison",a,async(l,o)=>{try{let u=new Date,p=new Date(u.getTime()-720*60*60*1e3),d=new Date(u.getTime()-1440*60*60*1e3),f=await x.getPeriodComparison(p,u,d,p);o.json(f)}catch{o.status(500).json({error:"Failed to fetch comparison data"})}}),e.get("/api/admin/coupons",a,async(l,o)=>{try{let u=await x.getCoupons();o.json(u)}catch{o.status(500).json({error:"Failed to fetch coupons"})}}),e.get("/api/admin/coupons/:id",a,async(l,o)=>{try{let u=await x.getCoupon(l.params.id);if(!u)return o.status(404).json({error:"Coupon not found"});o.json(u)}catch{o.status(500).json({error:"Failed to fetch coupon"})}}),e.post("/api/admin/coupons",a,async(l,o)=>{try{let u=await x.createCoupon(l.body);o.status(201).json(u)}catch(u){o.status(500).json({error:u.message||"Failed to create coupon"})}}),e.put("/api/admin/coupons/:id",a,async(l,o)=>{try{let u=await x.updateCoupon(l.params.id,l.body);if(!u)return o.status(404).json({error:"Coupon not found"});o.json(u)}catch{o.status(500).json({error:"Failed to update coupon"})}}),e.delete("/api/admin/coupons/:id",a,async(l,o)=>{try{await x.deleteCoupon(l.params.id),o.json({success:!0})}catch{o.status(500).json({error:"Failed to delete coupon"})}}),e.get("/api/admin/coupons/by-code/:code",a,async(l,o)=>{try{let u=await x.getCouponByCode(l.params.code);if(!u)return o.status(404).json({error:"Coupon not found"});o.json(u)}catch{o.status(500).json({error:"Failed to fetch coupon"})}}),e.post("/api/coupons/validate",async(l,o)=>{try{let{code:u,orderTotal:p}=l.body,d=await ft(l,o),f=d?.type==="user"?d.userId??null:null,m=await x.validateCoupon(u,p,f||void 0);o.json(m)}catch{o.status(500).json({error:"Failed to validate coupon"})}}),e.get("/api/admin/inventory",a,async(l,o)=>{try{let u=await x.getAllVariantsWithProducts();o.json(u)}catch{o.status(500).json({error:"Failed to fetch inventory"})}}),e.get("/api/admin/inventory/low-stock",a,async(l,o)=>{try{let u=parseInt(l.query.threshold)||5,p=await x.getLowStockVariants(u);o.json(p)}catch{o.status(500).json({error:"Failed to fetch low stock items"})}}),e.post("/api/admin/inventory/bulk-update",a,async(l,o)=>{try{let{updates:u}=l.body;await x.bulkUpdateStock(u.map(p=>({...p,authorId:l.adminId}))),o.json({success:!0})}catch{o.status(500).json({error:"Failed to bulk update stock"})}}),e.get("/api/admin/inventory/adjustments",a,async(l,o)=>{try{let u=l.query.variantId,p=await x.getStockAdjustments(u);o.json(p)}catch{o.status(500).json({error:"Failed to fetch stock adjustments"})}}),e.get("/api/admin/inventory/data-check",a,async(l,o)=>{try{let u=await x.getProducts(),p=await x.getAllVariantsWithProducts(),d=await x.getOrders(),f={productsWithoutVariants:[],productsWithMissingVariants:[],ordersWithoutVariants:[]};for(let m of u){let h=p.filter(g=>g.productId===m.id);if(h.length===0&&m.availableSizes&&m.availableSizes.length>0)f.productsWithoutVariants.push({id:m.id,name:m.name,sku:m.sku,availableSizes:m.availableSizes});else if(m.availableSizes&&m.availableSizes.length>0){let g=h.map(S=>S.size).filter(Boolean),y=m.availableSizes;y.filter(S=>!g.includes(S)).length>0&&f.productsWithMissingVariants.push({id:m.id,name:m.name,definedSizes:y,existingVariantSizes:g})}}for(let m of d){let g=(await x.getOrderItems(m.id)).filter(y=>!y.variantId);g.length>0&&f.ordersWithoutVariants.push({id:m.id,orderNumber:m.orderNumber,itemsWithoutVariant:g.map(y=>({productName:y.productName,variantDetails:y.variantDetails}))})}o.json({summary:{productsWithoutVariants:f.productsWithoutVariants.length,productsWithMissingVariants:f.productsWithMissingVariants.length,ordersWithoutVariants:f.ordersWithoutVariants.length},issues:f})}catch(u){console.error("Data check error:",u),o.status(500).json({error:"Failed to check data consistency"})}}),e.post("/api/admin/products/:id/sync-variants",a,async(l,o)=>{try{let u=await x.getProduct(l.params.id);if(!u)return o.status(404).json({error:"\xDCr\xFCn bulunamad\u0131"});let p=await x.getProductVariants(u.id),d=u.availableSizes||[],f=u.availableColors||[],m=u.sku||"",h=0,g=0;if(d.length===0)for(let b of p)await x.deleteProductVariant(b.id),g++;else{for(let b of p)b.size&&!d.includes(b.size)&&(await x.deleteProductVariant(b.id),g++);for(let b of d)if(f.length>0){for(let S of f)if(!p.some(A=>A.size===b&&A.color===S.name)){let A=m?`${m}-${b}`:null;await x.createProductVariant({productId:u.id,size:b,color:S.name,sku:A,stock:0,price:u.basePrice}),h++}}else if(!p.some(T=>T.size===b)){let T=m?`${m}-${b}`:null;await x.createProductVariant({productId:u.id,size:b,color:null,sku:T,stock:0,price:u.basePrice}),h++}}let y="";h>0&&g>0?y=`${h} varyant olu\u015Fturuldu, ${g} varyant silindi`:h>0?y=`${h} varyant olu\u015Fturuldu`:g>0?y=`${g} varyant silindi`:y="Varyantlar zaten senkronize",o.json({success:!0,createdCount:h,deletedCount:g,message:y})}catch(u){console.error("Sync variants error:",u),o.status(500).json({error:"Varyant senkronizasyonu ba\u015Far\u0131s\u0131z"})}}),e.post("/api/admin/inventory/fix-variants",a,async(l,o)=>{try{let u=await x.getProducts(),p=await x.getAllVariantsWithProducts(),d=0,f=0,m=[],h=[];for(let y of u){let b=p.filter(k=>k.productId===y.id),S=y.availableSizes||[],T=y.availableColors||[],A=y.sku||"";if(S.length===0){for(let k of b)await x.deleteProductVariant(k.id),f++,h.push({productName:y.name,size:k.size});continue}for(let k of b)k.size&&!S.includes(k.size)&&(await x.deleteProductVariant(k.id),f++,h.push({productName:y.name,size:k.size}));for(let k of S)if(T.length>0){for(let I of T)if(!b.some($=>$.size===k&&$.color===I.name)){let $=A?`${A}-${k}`:null;await x.createProductVariant({productId:y.id,size:k,color:I.name,sku:$,stock:0,price:y.basePrice}),d++,m.push({productName:y.name,size:k,sku:$})}}else if(!b.some(P=>P.size===k)){let P=A?`${A}-${k}`:null;await x.createProductVariant({productId:y.id,size:k,color:null,sku:P,stock:0,price:y.basePrice}),d++,m.push({productName:y.name,size:k,sku:P})}}let g="";d>0&&f>0?g=`${d} varyant olu\u015Fturuldu, ${f} varyant silindi`:d>0?g=`${d} eksik varyant olu\u015Fturuldu`:f>0?g=`${f} fazla varyant silindi`:g="T\xFCm varyantlar senkronize, de\u011Fi\u015Fiklik yok",o.json({success:!0,createdCount:d,deletedCount:f,createdVariants:m,deletedVariants:h,message:g})}catch(u){console.error("Fix variants error:",u),o.status(500).json({error:"Failed to fix missing variants"})}}),e.get("/api/admin/orders/:id/notes",a,async(l,o)=>{try{let u=await x.getOrderNotes(l.params.id);o.json(u)}catch{o.status(500).json({error:"Failed to fetch order notes"})}}),e.post("/api/admin/orders/:id/notes",a,async(l,o)=>{try{let u=await x.createOrderNote({orderId:l.params.id,authorId:l.adminId,content:l.body.content,isPrivate:l.body.isInternal!==!1});o.status(201).json(u)}catch{o.status(500).json({error:"Failed to create order note"})}}),e.put("/api/admin/orders/:id/tracking",a,async(l,o)=>{try{let{trackingNumber:u,trackingUrl:p,shippingCarrier:d}=l.body,f=await x.updateOrderTracking(l.params.id,{trackingNumber:u,trackingUrl:p,shippingCarrier:d});if(!f)return o.status(404).json({error:"Order not found"});o.json(f)}catch{o.status(500).json({error:"Failed to update tracking"})}}),e.put("/api/admin/orders/:id",a,async(l,o)=>{try{let u=await x.updateOrder(l.params.id,l.body);if(!u)return o.status(404).json({error:"Order not found"});o.json(u)}catch{o.status(500).json({error:"Failed to update order"})}}),e.post("/api/admin/orders/:id/cancel",a,async(l,o)=>{try{let u=await x.getOrder(l.params.id);if(!u)return o.status(404).json({error:"Order not found"});let p=await x.getOrderItems(u.id);for(let f of p)if(f.variantId){let m=await x.getProductVariant(f.variantId);if(m){let h=m.stock+f.quantity;await x.updateProductVariant(m.id,{stock:h}),await x.createStockAdjustment({variantId:m.id,previousStock:m.stock,newStock:h,adjustmentType:"return",reason:`Sipari\u015F iptali: ${u.orderNumber}`})}}let d=await x.updateOrder(l.params.id,{status:"cancelled",paymentStatus:"refunded"});await x.createOrderNote({orderId:l.params.id,authorType:"admin",noteType:"status_change",content:`Sipari\u015F iptal edildi. Sebep: ${l.body.reason||"Belirtilmedi"}`,isPrivate:!1}),o.json(d)}catch(u){console.error("Order cancellation error:",u),o.status(500).json({error:"Failed to cancel order"})}}),e.get("/api/admin/users/:id/stats",a,async(l,o)=>{try{let u=await x.getUser(l.params.id);if(!u)return o.status(404).json({error:"User not found"});let p=await x.getUserOrderStats(u.email);o.json(p)}catch{o.status(500).json({error:"Failed to fetch user stats"})}}),e.get("/api/admin/influencer-coupons",a,async(l,o)=>{try{let u=await x.getInfluencerCoupons();o.json(u)}catch{o.status(500).json({error:"Failed to fetch influencer coupons"})}}),e.post("/api/admin/influencer-coupons/:id/pay",a,async(l,o)=>{try{let u=await x.markInfluencerPaid(l.params.id);if(!u)return o.status(404).json({error:"Coupon not found"});o.json(u)}catch{o.status(500).json({error:"Failed to mark as paid"})}}),e.post("/api/admin/influencer-coupons/bulk",a,async(l,o)=>{try{let{influencers:u}=l.body;if(!Array.isArray(u)||u.length===0)return o.status(400).json({error:"No influencers provided"});let p=[];for(let d of u)try{let f=await x.createCoupon({code:d.code.toUpperCase(),description:`${d.name||d.code} - Influencer Kodu`,discountType:"percentage",discountValue:String(d.customerDiscount||10),isActive:!0,isInfluencerCode:!0,influencerName:d.name||d.code,influencerInstagram:d.instagram||null,commissionType:"percentage",commissionValue:String(d.commissionPercent||5)});p.push({code:d.code,success:!0,id:f.id})}catch(f){p.push({code:d.code,success:!1,error:f.message})}o.json({results:p,success:p.filter(d=>d.success).length,failed:p.filter(d=>!d.success).length})}catch(u){console.error("Bulk influencer add error:",u),o.status(500).json({error:"Failed to add influencers"})}}),e.get("/api/admin/influencer-analytics",a,async(l,o)=>{try{let{startDate:u,endDate:p,couponId:d}=l.query,f=await x.getInfluencerCoupons(),h=await E.select({redemption:Ar,order:xe,coupon:De}).from(Ar).leftJoin(xe,N(Ar.orderId,xe.id)).leftJoin(De,N(Ar.couponId,De.id)).where(N(De.isInfluencerCode,!0)).orderBy(Pe(Ar.createdAt));if(u){let b=new Date(u);h=h.filter(S=>new Date(S.redemption.createdAt)>=b)}if(p){let b=new Date(p);b.setHours(23,59,59,999),h=h.filter(S=>new Date(S.redemption.createdAt)<=b)}d&&(h=h.filter(b=>b.coupon?.id===d));let g={};for(let b of h){let S=new Date(b.redemption.createdAt),T=`${S.getFullYear()}-${String(S.getMonth()+1).padStart(2,"0")}`;g[T]||(g[T]={month:T,count:0,revenue:0,commission:0}),g[T].count+=1,g[T].revenue+=parseFloat(b.order?.total||"0");let A=b.coupon;A&&A.commissionType==="percentage"?g[T].commission+=parseFloat(b.order?.total||"0")*parseFloat(A.commissionValue||"0")/100:A&&A.commissionType==="per_use"&&(g[T].commission+=parseFloat(A.commissionValue||"0"))}let y=Object.values(g).sort((b,S)=>b.month.localeCompare(S.month));o.json({influencers:f,monthlyData:y,redemptions:h.map(b=>({id:b.redemption.id,couponId:b.redemption.couponId,couponCode:b.coupon?.code,influencerName:b.coupon?.influencerName,orderId:b.order?.id,orderNumber:b.order?.orderNumber,orderTotal:b.order?.total,discountAmount:b.redemption.discountAmount,createdAt:b.redemption.createdAt})),totals:{totalRedemptions:h.length,totalRevenue:h.reduce((b,S)=>b+parseFloat(S.order?.total||"0"),0),totalCommission:Object.values(g).reduce((b,S)=>b+S.commission,0)}})}catch(u){console.error("Influencer analytics error:",u),o.status(500).json({error:"Failed to fetch influencer analytics"})}}),e.post("/api/admin/update-credentials",a,async(l,o)=>{try{let{newUsername:u,newPassword:p}=l.body;if(!u||!p)return o.status(400).json({error:"Username and password required"});let d=await ls.default.hash(p,10),f=await x.getAdminUser(l.adminId);if(!f)return o.status(404).json({error:"Admin not found"});await x.updateAdminUser(f.id,{username:u,password:d}),o.json({success:!0,message:"Credentials updated"})}catch(u){console.error("Credentials update error:",u),o.status(500).json({error:"Failed to update credentials"})}}),e.get("/api/admin/campaigns",a,async(l,o)=>{try{let u=await x.getCampaigns();o.json(u)}catch{o.status(500).json({error:"Failed to fetch campaigns"})}}),e.get("/api/admin/campaigns/:id",a,async(l,o)=>{try{let u=await x.getCampaign(l.params.id);if(!u)return o.status(404).json({error:"Campaign not found"});o.json(u)}catch{o.status(500).json({error:"Failed to fetch campaign"})}}),e.post("/api/admin/campaigns",a,async(l,o)=>{try{let u=await x.createCampaign(l.body);o.status(201).json(u)}catch(u){o.status(500).json({error:u.message||"Failed to create campaign"})}}),e.put("/api/admin/campaigns/:id",a,async(l,o)=>{try{let u=await x.updateCampaign(l.params.id,l.body);if(!u)return o.status(404).json({error:"Campaign not found"});o.json(u)}catch{o.status(500).json({error:"Failed to update campaign"})}}),e.delete("/api/admin/campaigns/:id",a,async(l,o)=>{try{await x.deleteCampaign(l.params.id),o.json({success:!0})}catch{o.status(500).json({error:"Failed to delete campaign"})}}),e.get("/api/admin/campaigns/:id/emails",a,async(l,o)=>{try{let u=await x.getEmailJobsByCampaign(l.params.id);o.json(u)}catch{o.status(500).json({error:"Failed to fetch campaign emails"})}}),e.get("/api/admin/email-recipients",a,async(l,o)=>{try{let u=l.query.segment||"all",p=await x.getEmailsForBulkSend(u);o.json(p)}catch{o.status(500).json({error:"Failed to fetch email recipients"})}}),e.get("/api/admin/settings",a,async(l,o)=>{try{let u=await x.getSiteSettings();u.smtp_pass&&(u.smtp_pass="\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022"),o.json(u)}catch{o.status(500).json({error:"Failed to fetch settings"})}}),e.post("/api/admin/settings",a,async(l,o)=>{try{let u=l.body;u.smtp_pass==="\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022"&&delete u.smtp_pass,await x.setSiteSettings(u),o.json({success:!0})}catch{o.status(500).json({error:"Failed to save settings"})}}),e.post("/api/admin/settings/test-email",a,async(l,o)=>{try{let{email:u}=l.body,p=await D1(u);p.success?o.json({success:!0,message:"Test e-postas\u0131 g\xF6nderildi"}):o.status(400).json({success:!1,error:p.error})}catch(u){o.status(500).json({error:u.message||"Test e-postas\u0131 g\xF6nderilemedi"})}}),e.get("/api/admin/abandoned-carts",a,async(l,o)=>{try{let u=await x.getUsersWithCartItems();o.json(u)}catch(u){console.error("[Admin] Abandoned carts error:",u),o.status(500).json({error:"Sepet bilgileri al\u0131namad\u0131"})}}),e.post("/api/admin/abandoned-carts/:userId/remind",a,async(l,o)=>{try{let{userId:u}=l.params,p=await x.getUser(u);if(!p)return o.status(404).json({error:"Kullan\u0131c\u0131 bulunamad\u0131"});let d=await x.getCartItems(u);if(d.length===0)return o.status(400).json({error:"Kullan\u0131c\u0131n\u0131n sepetinde \xFCr\xFCn yok"});let f=await Promise.all(d.map(async g=>{let y=g.variantId?await x.getProductVariant(g.variantId):null,b=y?.productId||g.productId,S=await x.getProduct(b);return{productName:S?.name||"\xDCr\xFCn",variantDetails:y?`${y.size||""} ${y.color||""}`.trim():"",price:S?.basePrice||"0",quantity:g.quantity}})),m=f.reduce((g,y)=>g+parseFloat(y.price)*y.quantity,0),h=await _m(p.email,p.firstName||"De\u011Ferli M\xFC\u015Fterimiz",f,m);h.success?o.json({success:!0,message:"Sepet hat\u0131rlatma e-postas\u0131 g\xF6nderildi"}):o.status(400).json({success:!1,error:h.error})}catch(u){console.error("[Admin] Cart reminder error:",u),o.status(500).json({error:u.message||"E-posta g\xF6nderilemedi"})}}),e.post("/api/admin/abandoned-carts/remind-all",a,async(l,o)=>{try{let u=await x.getUsersWithCartItems();if(u.length===0)return o.json({success:!0,sent:0,message:"Sepetinde \xFCr\xFCn olan kullan\u0131c\u0131 yok"});let p=0,d=0;for(let f of u)try{let m=await x.getCartItems(f.id),h=await Promise.all(m.map(async b=>{let S=b.variantId?await x.getProductVariant(b.variantId):null,T=S?.productId||b.productId,A=await x.getProduct(T);return{productName:A?.name||"\xDCr\xFCn",variantDetails:S?`${S.size||""} ${S.color||""}`.trim():"",price:A?.basePrice||"0",quantity:b.quantity}})),g=h.reduce((b,S)=>b+parseFloat(S.price)*S.quantity,0);(await _m(f.email,f.firstName||"De\u011Ferli M\xFC\u015Fterimiz",h,g)).success?p++:d++}catch(m){console.error(`[Admin] Failed to send cart reminder to ${f.email}:`,m),d++}o.json({success:!0,sent:p,failed:d,message:`${p} kullan\u0131c\u0131ya e-posta g\xF6nderildi${d>0?`, ${d} ba\u015Far\u0131s\u0131z`:""}`})}catch(u){console.error("[Admin] Bulk cart reminder error:",u),o.status(500).json({error:u.message||"E-postalar g\xF6nderilemedi"})}}),e.post("/api/auth/forgot-password",async(l,o)=>{try{let{email:u}=l.body,p=await x.getUserByEmail(u);if(!p)return o.json({success:!0,message:"E\u011Fer bu e-posta kay\u0131tl\u0131ysa, \u015Fifre s\u0131f\u0131rlama ba\u011Flant\u0131s\u0131 g\xF6nderildi."});let d=qD.default.randomBytes(32).toString("hex"),f=new Date(Date.now()+3600*1e3);await x.createPasswordResetToken(p.id,d,f),await q1(p,d),o.json({success:!0,message:"\u015Eifre s\u0131f\u0131rlama ba\u011Flant\u0131s\u0131 e-posta adresinize g\xF6nderildi."})}catch(u){console.error("[Auth] Forgot password error:",u),o.status(500).json({error:"\u015Eifre s\u0131f\u0131rlama i\u015Flemi ba\u015Far\u0131s\u0131z"})}}),e.post("/api/auth/reset-password",async(l,o)=>{try{let{token:u,newPassword:p}=l.body;if(!u||!p)return o.status(400).json({error:"Token ve yeni \u015Fifre gerekli"});if(p.length<6)return o.status(400).json({error:"\u015Eifre en az 6 karakter olmal\u0131"});let d=await x.getPasswordResetToken(u);if(!d)return o.status(400).json({error:"Ge\xE7ersiz veya s\xFCresi dolmu\u015F ba\u011Flant\u0131"});if(d.usedAt)return o.status(400).json({error:"Bu ba\u011Flant\u0131 zaten kullan\u0131lm\u0131\u015F"});if(new Date>d.expiresAt)return o.status(400).json({error:"Ba\u011Flant\u0131n\u0131n s\xFCresi dolmu\u015F"});let f=await ls.default.hash(p,10);await x.updateUser(d.userId,{password:f}),await x.markPasswordResetTokenUsed(u),o.json({success:!0,message:"\u015Eifreniz ba\u015Far\u0131yla g\xFCncellendi"})}catch(u){console.error("[Auth] Reset password error:",u),o.status(500).json({error:"\u015Eifre s\u0131f\u0131rlama i\u015Flemi ba\u015Far\u0131s\u0131z"})}}),e.get("/api/auth/verify-reset-token/:token",async(l,o)=>{try{let{token:u}=l.params,p=await x.getPasswordResetToken(u);if(!p||p.usedAt||new Date>p.expiresAt)return o.json({valid:!1});let d=await x.getUser(p.userId);o.json({valid:!0,email:d?.email||""})}catch{o.json({valid:!1})}}),e.post("/api/admin/orders/:id/send-shipping-email",a,async(l,o)=>{try{let u=await x.getOrder(l.params.id);if(!u)return o.status(404).json({error:"Sipari\u015F bulunamad\u0131"});let p=await bm(u);p.success?o.json({success:!0,message:"Kargo bildirimi g\xF6nderildi"}):o.status(400).json({error:p.error})}catch{o.status(500).json({error:"E-posta g\xF6nderilemedi"})}}),e.post("/api/admin/orders/:id/send-invoice",a,async(l,o)=>{try{let u=await x.getOrder(l.params.id);if(!u)return o.status(404).json({error:"Sipari\u015F bulunamad\u0131"});let p=await x.getOrderItems(u.id),d=new Map;for(let m of p)if(m.variantId){let h=await x.getProductVariant(m.variantId);h?.sku&&d.set(m.variantId,h.sku)}let f=await M1(u,p,d);f.success?o.json({success:!0,message:"Fatura BizimHesap'a g\xF6nderildi",guid:f.guid,url:f.url}):o.status(400).json({error:f.error||"Fatura g\xF6nderilemedi"})}catch(u){console.error("[BizimHesap] Manual invoice error:",u),o.status(500).json({error:"Fatura g\xF6nderilemedi"})}}),e.post("/api/admin/orders/:id/send-review-request",a,async(l,o)=>{try{let u=await x.getOrder(l.params.id);if(!u)return o.status(404).json({error:"Sipari\u015F bulunamad\u0131"});let d=(await x.getOrderItems(u.id)).map(m=>m.productName),f=await L1(u.customerEmail,u.customerName,u.orderNumber,d);f.success?o.json({success:!0,message:"De\u011Ferlendirme talebi g\xF6nderildi"}):o.status(400).json({error:f.error})}catch{o.status(500).json({error:"E-posta g\xF6nderilemedi"})}}),e.get("/sitemap.xml",async(l,o)=>{try{let u=l.protocol+"://"+l.get("host"),p=await x.getProducts(),d=await x.getCategories(),f=y=>y.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;"),m=y=>y?y.startsWith("http://")||y.startsWith("https://")?y:u+(y.startsWith("/")?y:"/"+y):"",h=`<?xml version="1.0" encoding="UTF-8"?>
